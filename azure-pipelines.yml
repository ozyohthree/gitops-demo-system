# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- azure-pipelines

pool:
  vmImage: ubuntu-latest

resources:
- repo: self

variables:
- name: tag
  value: '$(Build.BuildId)'
- group: MY_PROPERTIES
- name: DEV_NAMESPACE
  value: dev
- name: APP_NAME
  value: 'gitops-demo-system'
- name: HELM_CHART
  value: "https://github.com/ozyohthree/gitops-demo-deploy-config/tree/main/system-app/deploy"
- name: GIT_COMMIT
  value: $(Build.SourceVersion)
- name: GIT_BRANCH
  value: $(Build.SourceBranchName)
- name: REGISTRY_NAME
  value: $(REGISTRY_NAME)
- name: REGISTRY_USER
  value: $(QUAY_USER)
- name: REGISTRY_PASSWORD
  value: $(QUAY_PASS)
- name: APP_NAME
  value: $(APP_NAME)
- name: IMAGE_TAG
  value: "ado-v1"

steps:
- task: Docker@0
  inputs:
    containerregistrytype: 'Container Registry'
    action: 'Build an image'
    dockerFile: '**/Dockerfile.build'
    imageName: '$REGISTRY_NAME/$REGISTRY_USER/$APP_NAME:$IMAGE_TAG'
  
- task: Bash@3
  name: build_and_push
  inputs:
    targetType: 'inline'
    script: |
      # Write your commands here      
      echo "Image path: $REGISTRY_NAME/$REGISTRY_USER/$APP_NAME:$IMAGE_TAG"
      docker login $REGISTRY_NAME -u $REGISTRY_USER -p $REGISTRY_PASSWORD
      docker push "$REGISTRY_NAME/$REGISTRY_USER/$APP_NAME:$IMAGE_TAG"