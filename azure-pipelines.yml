# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- azure-pipelines

pool:
  vmImage: ubuntu-latest

resources:
- repo: self

variables:
- name: tag
  value: '$(Build.BuildId)'
- group: MY_PROPERTIES
- name: DEV_NAMESPACE
  value: dev
- name: APP_NAME
  value: "gitops-demo-system"
- name: HELM_CHART
  value: "https://github.com/ozyohthree/gitops-demo-deploy-config/tree/main/system-app/deploy"
- name: GIT_COMMIT
  value: $(Build.SourceVersion)
- name: GIT_BRANCH
  value: $(Build.SourceBranchName)
- name: IMAGE_TAG
  value: "ado"

steps:
- task: Docker@0
  inputs:
    containerregistrytype: 'Container Registry'
    action: 'Build an image'
    dockerFile: '**/Dockerfile.build'
    imageName: '$(Build.Repository.Name):$(Build.BuildId)'
  
- task: Bash@3
  name: set_image_tag
  inputs:
    targetType: 'inline'
    script: |
      # Write your commands here
      echo "Ver: $(GIT_COMMIT)"
      echo "##vso[task.setvariable variable=FULL_IMAGE_TAG;]release-$(GIT_COMMIT)"
      echo "$(QUAY_NAME) $(QUAY_USER) $(APP_NAME) $(IMAGE_TAG)"
      echo "Namespace: $(DEV_NAMESPACE)"
      echo "OCP: $(OCP_URL)"
      docker images